# Architecture Audit Plan

## Цель

Комплексный аудит архитектуры для выявления:
1. Устаревших ad-hoc решений, которые можно заменить универсальными
2. Пробелов в функциональности
3. Несоответствий между документацией и кодом
4. Возможностей оптимизации

---

## Области аудита

### A. Файловая архитектура

**Вопросы:**
1. Как модель видит файлы пользователя в контексте?
2. Как модель видит файлы, которые сама сгенерировала, но ещё не отправила?
3. Как модель видит файлы, которые уже отправила пользователю?
4. Есть ли единый механизм для всех состояний файлов?
5. Какие файлы кэшируются и как?

**Файлы для проверки:**
- `core/tools/helpers.py` - format_unified_files_section
- `cache/exec_cache.py` - pending files
- `cache/file_cache.py` - file bytes cache
- `db/models/user_file.py` - file metadata
- `telegram/handlers/claude.py` - context building

### B. Обработка сообщений (Message Pipeline)

**Вопросы:**
1. Сколько точек входа для разных типов сообщений?
2. Есть ли race conditions?
3. Насколько унифицирована обработка разных типов медиа?
4. Как работает батчинг сообщений?

**Файлы для проверки:**
- `telegram/handlers/claude.py`
- `telegram/handlers/files.py`
- `telegram/handlers/media_handlers.py`
- `telegram/media_processor.py`
- `core/message_queue.py`
- `core/upload_tracker.py` (если есть)

### C. Система оплаты

**Вопросы:**
1. Как контролируется баланс при вызове тулзов?
2. Что происходит при остановке генерации?
3. Есть ли защита от "нарисуй 100 картинок"?
4. Универсален ли механизм списания?

**Файлы для проверки:**
- `core/tools/cost_estimator.py`
- `services/balance_service.py`
- `telegram/middlewares/balance_middleware.py`
- `telegram/handlers/claude.py` (charging logic)

### D. Кэширование

**Вопросы:**
1. Что кэшируется в Redis?
2. Что НЕ кэшируется, но должно бы?
3. Как работает write-behind?
4. Как работает circuit breaker?

**Файлы для проверки:**
- `cache/client.py`
- `cache/user_cache.py`
- `cache/thread_cache.py`
- `cache/file_cache.py`
- `cache/exec_cache.py`
- `cache/write_behind.py`

### E. Инструменты (Tools)

**Вопросы:**
1. Насколько унифицирован интерфейс инструментов?
2. Как файлы из инструментов попадают к пользователю?
3. Как модель решает, отправлять ли файл?
4. Есть ли дублирование логики между инструментами?

**Файлы для проверки:**
- `core/tools/registry.py`
- `core/tools/execute_python.py`
- `core/tools/generate_image.py`
- `core/tools/render_latex.py`
- `core/tools/deliver_file.py`
- `core/tools/preview_file.py`

### F. Документация

**Вопросы:**
1. Соответствует ли docs/ текущему коду?
2. Есть ли устаревшие документы?
3. Все ли ключевые решения задокументированы?

**Файлы для проверки:**
- Все файлы в `docs/`
- Сравнение с актуальным кодом

---

## Порядок выполнения

1. **A. Файловая архитектура** - критично для универсальности
2. **B. Message Pipeline** - критично для стабильности
3. **C. Оплата** - критично для бизнес-логики
4. **D. Кэширование** - критично для производительности
5. **E. Tools** - важно для расширяемости
6. **F. Документация** - важно для поддержки

---

## Формат результатов

Для каждой области:

```markdown
## [Область]: Результаты аудита

### Текущее состояние
- Описание как работает сейчас

### Проблемы
1. Проблема 1
2. Проблема 2

### Рекомендации
1. Рекомендация 1 (приоритет: высокий/средний/низкий)
2. Рекомендация 2
```

---

## Результаты аудита

> Заполняется по мере выполнения
