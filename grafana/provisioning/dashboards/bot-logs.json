{
  "annotations": {"list": []},
  "editable": true,
  "fiscalYearStartMonth": 0,
  "graphTooltip": 1,
  "id": null,
  "links": [{"icon": "dashboard", "title": "Bot Metrics", "url": "/d/bot-metrics/bot-metrics", "keepTime": true}],
  "panels": [
    {"collapsed": false, "gridPos": {"h": 1, "w": 24, "x": 0, "y": 0}, "id": 100, "title": "Overview", "type": "row"},
    {
      "datasource": {"type": "loki", "uid": "loki"},
      "description": "User messages received",
      "fieldConfig": {"defaults": {"color": {"mode": "thresholds"}, "thresholds": {"mode": "absolute", "steps": [{"color": "#3B82F6", "value": null}]}, "unit": "short"}},
      "gridPos": {"h": 3, "w": 3, "x": 0, "y": 1},
      "id": 1,
      "options": {"colorMode": "value", "graphMode": "none", "reduceOptions": {"calcs": ["lastNotNull"]}},
      "targets": [{"expr": "sum(count_over_time({service=\"bot\"} | json | event=\"incoming_update\" [$__range]))", "refId": "A"}],
      "title": "Messages",
      "type": "stat"
    },
    {
      "datasource": {"type": "loki", "uid": "loki"},
      "description": "Claude API responses",
      "fieldConfig": {"defaults": {"color": {"mode": "thresholds"}, "thresholds": {"mode": "absolute", "steps": [{"color": "#6366F1", "value": null}]}, "unit": "short"}},
      "gridPos": {"h": 3, "w": 3, "x": 3, "y": 1},
      "id": 2,
      "options": {"colorMode": "value", "graphMode": "none", "reduceOptions": {"calcs": ["lastNotNull"]}},
      "targets": [{"expr": "sum(count_over_time({service=\"bot\"} | json | event=\"claude.get_message.complete\" [$__range]))", "refId": "A"}],
      "title": "Responses",
      "type": "stat"
    },
    {
      "datasource": {"type": "loki", "uid": "loki"},
      "description": "Tool executions",
      "fieldConfig": {"defaults": {"color": {"mode": "thresholds"}, "thresholds": {"mode": "absolute", "steps": [{"color": "#8B5CF6", "value": null}]}, "unit": "short"}},
      "gridPos": {"h": 3, "w": 3, "x": 6, "y": 1},
      "id": 3,
      "options": {"colorMode": "value", "graphMode": "none", "reduceOptions": {"calcs": ["lastNotNull"]}},
      "targets": [{"expr": "sum(count_over_time({service=\"bot\"} | json | event=\"tools.loop.tool_success\" [$__range]))", "refId": "A"}],
      "title": "Tool Calls",
      "type": "stat"
    },
    {
      "datasource": {"type": "loki", "uid": "loki"},
      "description": "Files uploaded by users",
      "fieldConfig": {"defaults": {"color": {"mode": "thresholds"}, "thresholds": {"mode": "absolute", "steps": [{"color": "#06B6D4", "value": null}]}, "unit": "short"}},
      "gridPos": {"h": 3, "w": 3, "x": 9, "y": 1},
      "id": 4,
      "options": {"colorMode": "value", "graphMode": "none", "reduceOptions": {"calcs": ["lastNotNull"]}},
      "targets": [{"expr": "sum(count_over_time({service=\"bot\"} | json | event=\"files_api.upload_success\" [$__range]))", "refId": "A"}],
      "title": "Files Up",
      "type": "stat"
    },
    {
      "datasource": {"type": "loki", "uid": "loki"},
      "description": "Files sent to users",
      "fieldConfig": {"defaults": {"color": {"mode": "thresholds"}, "thresholds": {"mode": "absolute", "steps": [{"color": "#10B981", "value": null}]}, "unit": "short"}},
      "gridPos": {"h": 3, "w": 3, "x": 12, "y": 1},
      "id": 5,
      "options": {"colorMode": "value", "graphMode": "none", "reduceOptions": {"calcs": ["lastNotNull"]}},
      "targets": [{"expr": "sum(count_over_time({service=\"bot\"} | json | event=\"tools.loop.generated_file_delivered\" [$__range]))", "refId": "A"}],
      "title": "Files Sent",
      "type": "stat"
    },
    {
      "datasource": {"type": "loki", "uid": "loki"},
      "description": "Total cost in USD",
      "fieldConfig": {"defaults": {"color": {"mode": "thresholds"}, "decimals": 3, "thresholds": {"mode": "absolute", "steps": [{"color": "#22C55E", "value": null}, {"color": "#EAB308", "value": 1}, {"color": "#EF4444", "value": 5}]}, "unit": "currencyUSD"}},
      "gridPos": {"h": 3, "w": 3, "x": 15, "y": 1},
      "id": 6,
      "options": {"colorMode": "value", "graphMode": "none", "reduceOptions": {"calcs": ["lastNotNull"]}},
      "targets": [
        {"expr": "sum(sum_over_time({service=\"bot\"} | json | event=\"claude_handler.user_charged\" | unwrap cost_usd [$__range])) + sum(sum_over_time({service=\"bot\"} | json | event=\"tools.loop.user_charged_for_tool\" | unwrap cost_usd [$__range]))", "refId": "A"}
      ],
      "title": "Total Cost",
      "type": "stat"
    },
    {
      "datasource": {"type": "loki", "uid": "loki"},
      "description": "Errors (level=error)",
      "fieldConfig": {"defaults": {"color": {"mode": "thresholds"}, "thresholds": {"mode": "absolute", "steps": [{"color": "#22C55E", "value": null}, {"color": "#EF4444", "value": 1}]}, "unit": "short"}},
      "gridPos": {"h": 3, "w": 3, "x": 18, "y": 1},
      "id": 7,
      "options": {"colorMode": "value", "graphMode": "none", "reduceOptions": {"calcs": ["lastNotNull"]}},
      "targets": [{"expr": "sum(count_over_time({service=\"bot\"} | json | level=\"error\" [$__range]))", "refId": "A"}],
      "title": "Errors",
      "type": "stat"
    },
    {
      "datasource": {"type": "loki", "uid": "loki"},
      "description": "Unique users",
      "fieldConfig": {"defaults": {"color": {"mode": "thresholds"}, "thresholds": {"mode": "absolute", "steps": [{"color": "#F59E0B", "value": null}]}, "unit": "short"}},
      "gridPos": {"h": 3, "w": 3, "x": 21, "y": 1},
      "id": 8,
      "options": {"colorMode": "value", "graphMode": "none", "reduceOptions": {"calcs": ["lastNotNull"]}},
      "targets": [{"expr": "count(sum by (user_id) (count_over_time({service=\"bot\"} | json | user_id!=\"\" [$__range])))", "refId": "A"}],
      "title": "Users",
      "type": "stat"
    },
    {"collapsed": false, "gridPos": {"h": 1, "w": 24, "x": 0, "y": 4}, "id": 101, "title": "Costs", "type": "row"},
    {
      "datasource": {"type": "loki", "uid": "loki"},
      "description": "Cost breakdown over time",
      "fieldConfig": {
        "defaults": {
          "color": {"mode": "palette-classic"},
          "custom": {"axisCenteredZero": false, "axisPlacement": "auto", "drawStyle": "bars", "fillOpacity": 80, "lineWidth": 1, "showPoints": "never", "stacking": {"mode": "normal"}},
          "decimals": 3,
          "unit": "currencyUSD"
        },
        "overrides": [
          {"matcher": {"id": "byName", "options": "Claude API"}, "properties": [{"id": "color", "value": {"fixedColor": "#6366F1", "mode": "fixed"}}]},
          {"matcher": {"id": "byName", "options": "Tools"}, "properties": [{"id": "color", "value": {"fixedColor": "#F59E0B", "mode": "fixed"}}]}
        ]
      },
      "gridPos": {"h": 7, "w": 12, "x": 0, "y": 5},
      "id": 10,
      "maxDataPoints": 20,
      "options": {"legend": {"calcs": ["sum"], "displayMode": "table", "placement": "right"}, "tooltip": {"mode": "multi", "sort": "desc"}},
      "targets": [
        {"expr": "sum(sum_over_time({service=\"bot\"} | json | event=\"claude_handler.user_charged\" | unwrap cost_usd [$__interval]))", "legendFormat": "Claude API", "refId": "A"},
        {"expr": "sum(sum_over_time({service=\"bot\"} | json | event=\"tools.loop.user_charged_for_tool\" | unwrap cost_usd [$__interval]))", "legendFormat": "Tools", "refId": "B"}
      ],
      "title": "Costs Over Time",
      "type": "timeseries"
    },
    {
      "datasource": {"type": "loki", "uid": "loki"},
      "description": "Cost by tool type",
      "fieldConfig": {
        "defaults": {
          "color": {"mode": "palette-classic"},
          "custom": {"axisCenteredZero": false, "axisPlacement": "auto", "drawStyle": "bars", "fillOpacity": 80, "lineWidth": 1, "showPoints": "never", "stacking": {"mode": "normal"}},
          "decimals": 3,
          "unit": "currencyUSD"
        }
      },
      "gridPos": {"h": 7, "w": 12, "x": 12, "y": 5},
      "id": 11,
      "maxDataPoints": 20,
      "options": {"legend": {"calcs": ["sum"], "displayMode": "table", "placement": "right"}, "tooltip": {"mode": "multi", "sort": "desc"}},
      "targets": [
        {"expr": "sum by (tool_name) (sum_over_time({service=\"bot\"} | json | event=\"tools.loop.user_charged_for_tool\" | tool_name!=\"\" | unwrap cost_usd [$__interval]))", "legendFormat": "{{tool_name}}", "refId": "A"}
      ],
      "title": "Tool Costs by Type",
      "type": "timeseries"
    },
    {"collapsed": false, "gridPos": {"h": 1, "w": 24, "x": 0, "y": 12}, "id": 102, "title": "User Activity", "type": "row"},
    {
      "datasource": {"type": "loki", "uid": "loki"},
      "description": "User events over time",
      "fieldConfig": {
        "defaults": {
          "color": {"mode": "palette-classic"},
          "custom": {"axisCenteredZero": false, "axisPlacement": "auto", "drawStyle": "bars", "fillOpacity": 80, "lineWidth": 1, "showPoints": "never", "stacking": {"mode": "normal"}},
          "unit": "short"
        },
        "overrides": [
          {"matcher": {"id": "byName", "options": "Messages"}, "properties": [{"id": "color", "value": {"fixedColor": "#3B82F6", "mode": "fixed"}}]},
          {"matcher": {"id": "byName", "options": "Responses"}, "properties": [{"id": "color", "value": {"fixedColor": "#6366F1", "mode": "fixed"}}]},
          {"matcher": {"id": "byName", "options": "Tool Calls"}, "properties": [{"id": "color", "value": {"fixedColor": "#8B5CF6", "mode": "fixed"}}]},
          {"matcher": {"id": "byName", "options": "Files Uploaded"}, "properties": [{"id": "color", "value": {"fixedColor": "#06B6D4", "mode": "fixed"}}]},
          {"matcher": {"id": "byName", "options": "Files Sent"}, "properties": [{"id": "color", "value": {"fixedColor": "#10B981", "mode": "fixed"}}]},
          {"matcher": {"id": "byName", "options": "Errors"}, "properties": [{"id": "color", "value": {"fixedColor": "#EF4444", "mode": "fixed"}}]}
        ]
      },
      "gridPos": {"h": 8, "w": 16, "x": 0, "y": 13},
      "id": 20,
      "maxDataPoints": 20,
      "options": {"legend": {"calcs": ["sum"], "displayMode": "table", "placement": "right"}, "tooltip": {"mode": "multi", "sort": "desc"}},
      "targets": [
        {"expr": "sum(count_over_time({service=\"bot\"} | json | event=\"incoming_update\" [$__interval]))", "legendFormat": "Messages", "refId": "A"},
        {"expr": "sum(count_over_time({service=\"bot\"} | json | event=\"claude.get_message.complete\" [$__interval]))", "legendFormat": "Responses", "refId": "B"},
        {"expr": "sum(count_over_time({service=\"bot\"} | json | event=\"tools.loop.tool_success\" [$__interval]))", "legendFormat": "Tool Calls", "refId": "C"},
        {"expr": "sum(count_over_time({service=\"bot\"} | json | event=\"files_api.upload_success\" [$__interval]))", "legendFormat": "Files Uploaded", "refId": "D"},
        {"expr": "sum(count_over_time({service=\"bot\"} | json | event=\"tools.loop.generated_file_delivered\" [$__interval]))", "legendFormat": "Files Sent", "refId": "E"},
        {"expr": "sum(count_over_time({service=\"bot\"} | json | level=\"error\" [$__interval]))", "legendFormat": "Errors", "refId": "F"}
      ],
      "title": "User Activity Over Time",
      "type": "timeseries"
    },
    {
      "datasource": {"type": "loki", "uid": "loki"},
      "description": "Tool calls breakdown",
      "fieldConfig": {"defaults": {"color": {"mode": "palette-classic"}, "unit": "short"}},
      "gridPos": {"h": 8, "w": 8, "x": 16, "y": 13},
      "id": 21,
      "options": {"legend": {"displayMode": "table", "placement": "right", "values": ["value"]}, "pieType": "pie", "reduceOptions": {"calcs": ["sum"]}, "tooltip": {"mode": "single"}},
      "targets": [{"expr": "sum by (tool_name) (count_over_time({service=\"bot\"} | json | event=\"tools.loop.tool_success\" | tool_name!=\"\" [$__range]))", "legendFormat": "{{tool_name}}", "refId": "A"}],
      "title": "Tool Calls by Type",
      "type": "piechart"
    },
    {"collapsed": false, "gridPos": {"h": 1, "w": 24, "x": 0, "y": 21}, "id": 103, "title": "Tokens & Files", "type": "row"},
    {
      "datasource": {"type": "loki", "uid": "loki"},
      "description": "Token usage over time",
      "fieldConfig": {
        "defaults": {
          "color": {"mode": "palette-classic"},
          "custom": {"axisCenteredZero": false, "axisPlacement": "auto", "drawStyle": "bars", "fillOpacity": 80, "lineWidth": 1, "showPoints": "never", "stacking": {"mode": "normal"}},
          "unit": "short"
        },
        "overrides": [
          {"matcher": {"id": "byName", "options": "Input"}, "properties": [{"id": "color", "value": {"fixedColor": "#3B82F6", "mode": "fixed"}}]},
          {"matcher": {"id": "byName", "options": "Output"}, "properties": [{"id": "color", "value": {"fixedColor": "#6366F1", "mode": "fixed"}}]},
          {"matcher": {"id": "byName", "options": "Cache Read"}, "properties": [{"id": "color", "value": {"fixedColor": "#22C55E", "mode": "fixed"}}]}
        ]
      },
      "gridPos": {"h": 7, "w": 12, "x": 0, "y": 22},
      "id": 30,
      "maxDataPoints": 20,
      "options": {"legend": {"calcs": ["sum"], "displayMode": "table", "placement": "right"}, "tooltip": {"mode": "multi", "sort": "desc"}},
      "targets": [
        {"expr": "sum(sum_over_time({service=\"bot\"} | json | event=\"claude.get_message.complete\" | unwrap input_tokens [$__interval]))", "legendFormat": "Input", "refId": "A"},
        {"expr": "sum(sum_over_time({service=\"bot\"} | json | event=\"claude.get_message.complete\" | unwrap output_tokens [$__interval]))", "legendFormat": "Output", "refId": "B"},
        {"expr": "sum(sum_over_time({service=\"bot\"} | json | event=\"claude.get_message.complete\" | unwrap cache_read_tokens [$__interval]))", "legendFormat": "Cache Read", "refId": "C"}
      ],
      "title": "Tokens Over Time",
      "type": "timeseries"
    },
    {
      "datasource": {"type": "loki", "uid": "loki"},
      "description": "File uploads by MIME type",
      "fieldConfig": {
        "defaults": {
          "color": {"mode": "palette-classic"},
          "custom": {"axisCenteredZero": false, "axisPlacement": "auto", "drawStyle": "bars", "fillOpacity": 80, "lineWidth": 1, "showPoints": "never", "stacking": {"mode": "normal"}},
          "unit": "short"
        }
      },
      "gridPos": {"h": 7, "w": 12, "x": 12, "y": 22},
      "id": 31,
      "maxDataPoints": 20,
      "options": {"legend": {"calcs": ["sum"], "displayMode": "table", "placement": "right"}, "tooltip": {"mode": "multi", "sort": "desc"}},
      "targets": [{"expr": "sum by (mime_type) (count_over_time({service=\"bot\"} | json | event=\"files_api.upload_success\" | mime_type!=\"\" [$__interval]))", "legendFormat": "{{mime_type}}", "refId": "A"}],
      "title": "File Uploads by Type",
      "type": "timeseries"
    },
    {"collapsed": false, "gridPos": {"h": 1, "w": 24, "x": 0, "y": 29}, "id": 104, "title": "Events Log", "type": "row"},
    {
      "datasource": {"type": "loki", "uid": "loki"},
      "description": "All events with details",
      "fieldConfig": {
        "defaults": {"color": {"mode": "thresholds"}, "custom": {"align": "auto", "displayMode": "auto", "filterable": true, "inspect": true}},
        "overrides": [
          {"matcher": {"id": "byName", "options": "Time"}, "properties": [{"id": "custom.width", "value": 180}]},
          {"matcher": {"id": "byName", "options": "event"}, "properties": [{"id": "custom.width", "value": 280}]},
          {"matcher": {"id": "byName", "options": "user_id"}, "properties": [{"id": "custom.width", "value": 120}]},
          {"matcher": {"id": "byName", "options": "level"}, "properties": [{"id": "custom.width", "value": 70}]}
        ]
      },
      "gridPos": {"h": 10, "w": 24, "x": 0, "y": 30},
      "id": 40,
      "options": {"footer": {"reducer": ["sum"], "show": false}, "showHeader": true, "sortBy": [{"desc": true, "displayName": "Time"}]},
      "targets": [{"expr": "{service=\"bot\"} | json | user_id=~\"$user_id\" | level=~\"$level\"", "refId": "A"}],
      "title": "Events Log",
      "transformations": [
        {"id": "extractFields", "options": {"format": "json", "keepTime": true, "replace": true, "source": "Line"}},
        {"id": "organize", "options": {"excludeByName": {"Line": true, "labels": true, "tsNs": true, "id": true, "timestamp": true}}}
      ],
      "type": "table"
    },
    {
      "collapsed": true,
      "gridPos": {"h": 1, "w": 24, "x": 0, "y": 40},
      "id": 105,
      "panels": [
        {
          "datasource": {"type": "loki", "uid": "loki"},
          "fieldConfig": {
            "defaults": {
              "color": {"mode": "palette-classic"},
              "custom": {"axisCenteredZero": false, "axisPlacement": "auto", "drawStyle": "bars", "fillOpacity": 80, "lineWidth": 1, "showPoints": "never", "stacking": {"mode": "normal"}},
              "unit": "short"
            },
            "overrides": [
              {"matcher": {"id": "byName", "options": "error"}, "properties": [{"id": "color", "value": {"fixedColor": "#EF4444", "mode": "fixed"}}]},
              {"matcher": {"id": "byName", "options": "info"}, "properties": [{"id": "color", "value": {"fixedColor": "#22C55E", "mode": "fixed"}}]}
            ]
          },
          "gridPos": {"h": 5, "w": 24, "x": 0, "y": 41},
          "id": 50,
          "maxDataPoints": 20,
          "options": {"legend": {"calcs": ["sum"], "displayMode": "table", "placement": "right"}, "tooltip": {"mode": "multi", "sort": "desc"}},
          "targets": [{"expr": "sum by (level) (count_over_time({service=\"bot\"} | json [$__interval]))", "legendFormat": "{{level}}", "refId": "A"}],
          "title": "Logs by Level",
          "type": "timeseries"
        },
        {
          "datasource": {"type": "loki", "uid": "loki"},
          "gridPos": {"h": 12, "w": 24, "x": 0, "y": 46},
          "id": 51,
          "options": {"dedupStrategy": "none", "enableLogDetails": true, "prettifyLogMessage": false, "showCommonLabels": false, "showLabels": false, "showTime": true, "sortOrder": "Descending", "wrapLogMessage": false},
          "targets": [{"expr": "{service=\"bot\"} | json | user_id=~\"$user_id\" | level=~\"$level\"", "refId": "A"}],
          "title": "Raw Logs",
          "type": "logs"
        }
      ],
      "title": "All Logs",
      "type": "row"
    }
  ],
  "refresh": "10s",
  "schemaVersion": 38,
  "tags": ["bot", "logs"],
  "templating": {
    "list": [
      {"current": {"selected": false, "text": "", "value": ""}, "hide": 0, "label": "User ID", "name": "user_id", "options": [{"selected": true, "text": "", "value": ""}], "query": "", "type": "textbox"},
      {"allValue": ".*", "current": {"selected": true, "text": "All", "value": "$__all"}, "hide": 0, "includeAll": true, "label": "Level", "multi": true, "name": "level", "options": [{"selected": false, "text": "error", "value": "error"}, {"selected": false, "text": "info", "value": "info"}], "query": "error,info", "type": "custom"}
    ]
  },
  "time": {"from": "now-1h", "to": "now"},
  "timepicker": {},
  "title": "Bot Logs",
  "uid": "bot-logs",
  "version": 1
}
