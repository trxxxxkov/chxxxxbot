{
  "annotations": {"list": []},
  "editable": true,
  "fiscalYearStartMonth": 0,
  "graphTooltip": 1,
  "id": null,
  "links": [{"icon": "dashboard", "title": "Bot Logs", "url": "/d/bot-logs/bot-logs", "keepTime": true}],
  "panels": [
    {"collapsed": false, "gridPos": {"h": 1, "w": 24, "x": 0, "y": 0}, "id": 100, "title": "Health", "type": "row"},
    {
      "datasource": {"type": "prometheus", "uid": "prometheus"},
      "fieldConfig": {
        "defaults": {
          "mappings": [{"options": {"0": {"color": "#EF4444", "text": "DOWN"}, "1": {"color": "#22C55E", "text": "UP"}}, "type": "value"}],
          "thresholds": {"mode": "absolute", "steps": [{"color": "#22C55E", "value": null}]}
        }
      },
      "gridPos": {"h": 4, "w": 3, "x": 0, "y": 1},
      "id": 1,
      "options": {"colorMode": "value", "graphMode": "none", "reduceOptions": {"calcs": ["lastNotNull"]}},
      "targets": [{"expr": "up{job=\"bot\"}", "refId": "A"}],
      "title": "Status",
      "type": "stat"
    },
    {
      "datasource": {"type": "loki", "uid": "loki"},
      "description": "Errors (level=error)",
      "fieldConfig": {
        "defaults": {
          "color": {"mode": "thresholds"},
          "thresholds": {"mode": "absolute", "steps": [{"color": "#22C55E", "value": null}, {"color": "#EAB308", "value": 1}, {"color": "#EF4444", "value": 5}]},
          "unit": "short"
        }
      },
      "gridPos": {"h": 4, "w": 3, "x": 3, "y": 1},
      "id": 2,
      "options": {"colorMode": "value", "graphMode": "area", "reduceOptions": {"calcs": ["sum"]}},
      "targets": [{"expr": "sum(count_over_time({service=\"bot\"} | json | level=\"error\" [$__range]))", "refId": "A"}],
      "title": "Errors",
      "type": "stat"
    },
    {
      "datasource": {"type": "loki", "uid": "loki"},
      "description": "Unique users in time range",
      "fieldConfig": {"defaults": {"color": {"mode": "thresholds"}, "thresholds": {"mode": "absolute", "steps": [{"color": "#3B82F6", "value": null}]}, "unit": "short"}},
      "gridPos": {"h": 4, "w": 3, "x": 6, "y": 1},
      "id": 3,
      "options": {"colorMode": "value", "graphMode": "area", "reduceOptions": {"calcs": ["sum"]}},
      "targets": [{"expr": "count(sum by (user_id) (count_over_time({service=\"bot\"} | json | user_id!=\"\" [$__range])))", "refId": "A"}],
      "title": "Active Users",
      "type": "stat"
    },
    {
      "datasource": {"type": "prometheus", "uid": "prometheus"},
      "fieldConfig": {"defaults": {"color": {"mode": "thresholds"}, "thresholds": {"mode": "absolute", "steps": [{"color": "#22C55E", "value": null}, {"color": "#EAB308", "value": 500000000}, {"color": "#EF4444", "value": 1000000000}]}, "unit": "decbytes"}},
      "gridPos": {"h": 4, "w": 3, "x": 9, "y": 1},
      "id": 4,
      "options": {"colorMode": "value", "graphMode": "area", "reduceOptions": {"calcs": ["lastNotNull"]}},
      "targets": [{"expr": "process_resident_memory_bytes{job=\"bot\"}", "refId": "A"}],
      "title": "Memory",
      "type": "stat"
    },
    {
      "datasource": {"type": "loki", "uid": "loki"},
      "description": "Total input tokens",
      "fieldConfig": {"defaults": {"color": {"mode": "thresholds"}, "thresholds": {"mode": "absolute", "steps": [{"color": "#3B82F6", "value": null}]}, "unit": "short"}},
      "gridPos": {"h": 4, "w": 3, "x": 12, "y": 1},
      "id": 5,
      "options": {"colorMode": "value", "graphMode": "area", "reduceOptions": {"calcs": ["sum"]}},
      "targets": [{"expr": "sum(sum_over_time({service=\"bot\"} | json | event=\"claude.get_message.complete\" | unwrap input_tokens [$__range]))", "refId": "A"}],
      "title": "Input Tokens",
      "type": "stat"
    },
    {
      "datasource": {"type": "loki", "uid": "loki"},
      "description": "Total output tokens",
      "fieldConfig": {"defaults": {"color": {"mode": "thresholds"}, "thresholds": {"mode": "absolute", "steps": [{"color": "#6366F1", "value": null}]}, "unit": "short"}},
      "gridPos": {"h": 4, "w": 3, "x": 15, "y": 1},
      "id": 6,
      "options": {"colorMode": "value", "graphMode": "area", "reduceOptions": {"calcs": ["sum"]}},
      "targets": [{"expr": "sum(sum_over_time({service=\"bot\"} | json | event=\"claude.get_message.complete\" | unwrap output_tokens [$__range]))", "refId": "A"}],
      "title": "Output Tokens",
      "type": "stat"
    },
    {
      "datasource": {"type": "loki", "uid": "loki"},
      "description": "Claude API responses",
      "fieldConfig": {"defaults": {"color": {"mode": "thresholds"}, "thresholds": {"mode": "absolute", "steps": [{"color": "#8B5CF6", "value": null}]}, "unit": "short"}},
      "gridPos": {"h": 4, "w": 3, "x": 18, "y": 1},
      "id": 7,
      "options": {"colorMode": "value", "graphMode": "area", "reduceOptions": {"calcs": ["sum"]}},
      "targets": [{"expr": "sum(count_over_time({service=\"bot\"} | json | event=\"claude.get_message.complete\" [$__range]))", "refId": "A"}],
      "title": "API Calls",
      "type": "stat"
    },
    {
      "datasource": {"type": "loki", "uid": "loki"},
      "description": "Files uploaded",
      "fieldConfig": {"defaults": {"color": {"mode": "thresholds"}, "thresholds": {"mode": "absolute", "steps": [{"color": "#06B6D4", "value": null}]}, "unit": "short"}},
      "gridPos": {"h": 4, "w": 3, "x": 21, "y": 1},
      "id": 8,
      "options": {"colorMode": "value", "graphMode": "area", "reduceOptions": {"calcs": ["sum"]}},
      "targets": [{"expr": "sum(count_over_time({service=\"bot\"} | json | event=\"files_api.upload_success\" [$__range]))", "refId": "A"}],
      "title": "Files",
      "type": "stat"
    },
    {"collapsed": false, "gridPos": {"h": 1, "w": 24, "x": 0, "y": 5}, "id": 101, "title": "Performance", "type": "row"},
    {
      "datasource": {"type": "loki", "uid": "loki"},
      "description": "Claude response time from logs",
      "fieldConfig": {
        "defaults": {
          "color": {"mode": "palette-classic"},
          "custom": {"axisCenteredZero": false, "axisPlacement": "auto", "drawStyle": "bars", "fillOpacity": 80, "lineWidth": 1, "showPoints": "never", "stacking": {"mode": "none"}},
          "unit": "ms"
        }
      },
      "gridPos": {"h": 8, "w": 12, "x": 0, "y": 6},
      "id": 10,
      "maxDataPoints": 20,
      "options": {"legend": {"calcs": ["mean", "max"], "displayMode": "table", "placement": "bottom"}, "tooltip": {"mode": "multi", "sort": "desc"}},
      "targets": [
        {"expr": "avg(avg_over_time({service=\"bot\"} | json | event=\"claude.get_message.complete\" | unwrap duration_ms [$__interval]))", "legendFormat": "Avg Response Time", "refId": "A"},
        {"expr": "max(max_over_time({service=\"bot\"} | json | event=\"claude.get_message.complete\" | unwrap duration_ms [$__interval]))", "legendFormat": "Max Response Time", "refId": "B"}
      ],
      "title": "Claude Response Time",
      "type": "timeseries"
    },
    {
      "datasource": {"type": "loki", "uid": "loki"},
      "description": "Requests by model",
      "fieldConfig": {
        "defaults": {
          "color": {"mode": "palette-classic"},
          "custom": {"axisCenteredZero": false, "axisPlacement": "auto", "drawStyle": "bars", "fillOpacity": 80, "lineWidth": 1, "showPoints": "never", "stacking": {"mode": "normal"}},
          "unit": "short"
        },
        "overrides": [
          {"matcher": {"id": "byName", "options": "claude:haiku"}, "properties": [{"id": "color", "value": {"fixedColor": "#22C55E", "mode": "fixed"}}]},
          {"matcher": {"id": "byName", "options": "claude:sonnet"}, "properties": [{"id": "color", "value": {"fixedColor": "#6366F1", "mode": "fixed"}}]},
          {"matcher": {"id": "byName", "options": "claude:opus"}, "properties": [{"id": "color", "value": {"fixedColor": "#EF4444", "mode": "fixed"}}]}
        ]
      },
      "gridPos": {"h": 8, "w": 12, "x": 12, "y": 6},
      "id": 11,
      "maxDataPoints": 20,
      "options": {"legend": {"calcs": ["sum"], "displayMode": "table", "placement": "bottom"}, "tooltip": {"mode": "multi", "sort": "desc"}},
      "targets": [{"expr": "sum by (model_full_id) (count_over_time({service=\"bot\"} | json | event=\"claude.get_message.complete\" | model_full_id!=\"\" [$__interval]))", "legendFormat": "{{model_full_id}}", "refId": "A"}],
      "title": "API Requests by Model",
      "type": "timeseries"
    },
    {
      "datasource": {"type": "loki", "uid": "loki"},
      "description": "Tool execution breakdown",
      "fieldConfig": {
        "defaults": {
          "color": {"mode": "palette-classic"},
          "custom": {"axisCenteredZero": false, "axisPlacement": "auto", "drawStyle": "bars", "fillOpacity": 80, "lineWidth": 1, "showPoints": "never", "stacking": {"mode": "normal"}},
          "unit": "short"
        }
      },
      "gridPos": {"h": 8, "w": 12, "x": 0, "y": 14},
      "id": 12,
      "maxDataPoints": 20,
      "options": {"legend": {"calcs": ["sum"], "displayMode": "table", "placement": "bottom"}, "tooltip": {"mode": "multi", "sort": "desc"}},
      "targets": [{"expr": "sum by (tool_name) (count_over_time({service=\"bot\"} | json | event=\"tools.loop.tool_success\" | tool_name!=\"\" [$__interval]))", "legendFormat": "{{tool_name}}", "refId": "A"}],
      "title": "Tool Calls by Type",
      "type": "timeseries"
    },
    {
      "datasource": {"type": "loki", "uid": "loki"},
      "description": "Token usage over time",
      "fieldConfig": {
        "defaults": {
          "color": {"mode": "palette-classic"},
          "custom": {"axisCenteredZero": false, "axisPlacement": "auto", "drawStyle": "bars", "fillOpacity": 80, "lineWidth": 1, "showPoints": "never", "stacking": {"mode": "normal"}},
          "unit": "short"
        },
        "overrides": [
          {"matcher": {"id": "byName", "options": "Input"}, "properties": [{"id": "color", "value": {"fixedColor": "#3B82F6", "mode": "fixed"}}]},
          {"matcher": {"id": "byName", "options": "Output"}, "properties": [{"id": "color", "value": {"fixedColor": "#6366F1", "mode": "fixed"}}]},
          {"matcher": {"id": "byName", "options": "Cache Read"}, "properties": [{"id": "color", "value": {"fixedColor": "#22C55E", "mode": "fixed"}}]}
        ]
      },
      "gridPos": {"h": 8, "w": 12, "x": 12, "y": 14},
      "id": 13,
      "maxDataPoints": 20,
      "options": {"legend": {"calcs": ["sum"], "displayMode": "table", "placement": "bottom"}, "tooltip": {"mode": "multi", "sort": "desc"}},
      "targets": [
        {"expr": "sum(sum_over_time({service=\"bot\"} | json | event=\"claude.get_message.complete\" | unwrap input_tokens [$__interval]))", "legendFormat": "Input", "refId": "A"},
        {"expr": "sum(sum_over_time({service=\"bot\"} | json | event=\"claude.get_message.complete\" | unwrap output_tokens [$__interval]))", "legendFormat": "Output", "refId": "B"},
        {"expr": "sum(sum_over_time({service=\"bot\"} | json | event=\"claude.get_message.complete\" | unwrap cache_read_tokens [$__interval]))", "legendFormat": "Cache Read", "refId": "C"}
      ],
      "title": "Token Usage",
      "type": "timeseries"
    },
    {
      "collapsed": true,
      "gridPos": {"h": 1, "w": 24, "x": 0, "y": 22},
      "id": 102,
      "panels": [
        {
          "datasource": {"type": "prometheus", "uid": "prometheus"},
          "fieldConfig": {
            "defaults": {"color": {"mode": "palette-classic"}, "custom": {"axisCenteredZero": false, "axisPlacement": "auto", "drawStyle": "line", "fillOpacity": 20, "lineInterpolation": "smooth", "lineWidth": 2, "showPoints": "never", "stacking": {"mode": "normal"}}, "unit": "short"},
            "overrides": [
              {"matcher": {"id": "byName", "options": "Active"}, "properties": [{"id": "color", "value": {"fixedColor": "#EF4444", "mode": "fixed"}}]},
              {"matcher": {"id": "byName", "options": "Idle"}, "properties": [{"id": "color", "value": {"fixedColor": "#22C55E", "mode": "fixed"}}]}
            ]
          },
          "gridPos": {"h": 6, "w": 12, "x": 0, "y": 23},
          "id": 20,
          "options": {"legend": {"calcs": ["mean", "max"], "displayMode": "table", "placement": "bottom"}, "tooltip": {"mode": "multi"}},
          "targets": [
            {"expr": "bot_db_connections_active", "legendFormat": "Active", "refId": "A"},
            {"expr": "bot_db_connections_idle", "legendFormat": "Idle", "refId": "B"}
          ],
          "title": "DB Connection Pool",
          "type": "timeseries"
        },
        {
          "datasource": {"type": "prometheus", "uid": "prometheus"},
          "fieldConfig": {
            "defaults": {"color": {"mode": "palette-classic"}, "custom": {"axisCenteredZero": false, "axisPlacement": "auto", "drawStyle": "line", "fillOpacity": 10, "lineInterpolation": "smooth", "lineWidth": 2, "showPoints": "never", "stacking": {"mode": "none"}}, "unit": "decbytes"}
          },
          "gridPos": {"h": 6, "w": 12, "x": 12, "y": 23},
          "id": 21,
          "options": {"legend": {"calcs": ["mean", "max"], "displayMode": "table", "placement": "bottom"}, "tooltip": {"mode": "multi"}},
          "targets": [
            {"expr": "process_resident_memory_bytes{job=\"bot\"}", "legendFormat": "RSS", "refId": "A"},
            {"expr": "process_virtual_memory_bytes{job=\"bot\"}", "legendFormat": "Virtual", "refId": "B"}
          ],
          "title": "Memory Usage",
          "type": "timeseries"
        }
      ],
      "title": "Infrastructure",
      "type": "row"
    }
  ],
  "refresh": "10s",
  "schemaVersion": 38,
  "tags": ["bot", "metrics"],
  "templating": {"list": []},
  "time": {"from": "now-1h", "to": "now"},
  "timepicker": {"refresh_intervals": ["5s", "10s", "30s", "1m", "5m"], "time_options": ["5m", "15m", "1h", "6h", "12h", "24h", "2d", "7d"]},
  "title": "Bot Metrics",
  "uid": "bot-metrics",
  "version": 1
}
